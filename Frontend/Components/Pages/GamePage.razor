@page "/Game"
@rendermode InteractiveServer
@inject GameService.GameServiceClient GameClient
@using Frontend.Components.Cards
@using Frontend.Components.Other
@using Frontend.Helpers
@using GameServiceProtos
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Game Nr. @GameId</PageTitle>


@if (_gameInfo == null || _comments == null)
{
    <Loading/>
}
else
{
    <MudCard Outlined="true">
        <MudCardHeader>
            <MudText Typo="Typo.h2">@_gameInfo.Name</MudText>
        </MudCardHeader>
        <MudCardContent>
          <MudRating MaxValue="5" SelectedValue="@_userRating" SelectedValueChanged="@(rating => RateGame(rating))" />
            <MudText>Average rating: @_gameInfo.AverageRating</MudText>
            <MudText>Comments: @_gameInfo.CommentCount</MudText>
            <MudText>Publisher: @_gameInfo.Publisher</MudText>
            <MudText>Developer: @_gameInfo.Developer</MudText>
            <MudText>Platform: @_gameInfo.Platform</MudText>
            <MudText>Genre: @_gameInfo.Genre</MudText>
            <MudCardActions>
                <MudButton OnClick="@DeleteGame">Delete Game</MudButton>
            </MudCardActions>
        </MudCardContent>
    </MudCard>
    <MudDivider/>
    <MudCard>
        <MudCardHeader>
            <MudText>Add a new Comment</MudText>
            <MudCardContent>
                <MudTextField Variant="Variant.Outlined" @bind-Value="@_newComment"></MudTextField>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Button" OnClick="@(async () => await AddComment())">Save Comment</MudButton>
            </MudCardActions>
        </MudCardHeader>
        
    </MudCard>
    <MudDivider/>
    <MudGrid>
        
    @foreach(var comment in _comments)
    {
        <MudItem xs="12" md="6" xl="4">
         <MudCommentCard Comment="comment" RefreshData="@RefreshData()" DeleteComment="@DeleteComment"></MudCommentCard>
        </MudItem>
    }
    </MudGrid>
}

@code {
    
    [Parameter, SupplyParameterFromQuery(Name = "Id")]
    public required int GameId { get; set; }

    List<GameComment>? _comments;
    Game? _gameInfo;
    private int _userRating;
    string _newComment = "";

    private async Task AddComment()
    {
        await GameClient.AddGameCommentAsync(new AddGameCommentRequest { Content = _newComment, GameId = GameId }, HttpConfig.Headers);
        _newComment = "";
        await RefreshData();
    }

    private async Task RefreshData()
    {
        var response = await GameClient.GetGameWithCommentsAndRatingAsync(new GameWithCommentsAndRatingRequest { GameId = GameId }, HttpConfig.Headers);
        _comments = response.Comments.ToList();

        if (response.UserRating != null)
        {
            _userRating = (int)response.UserRating;
        }

        _gameInfo = new Game
        {
            Name = response.Name,
            Id = response.Id,
            ReleaseDate = response.ReleaseDate,
            Publisher = response.Publisher,
            Developer = response.DevStudio,
            Genre = response.Genre,
            Platform = response.Platform,
            AverageRating = response.AverageRating,
            CommentCount = _comments.Count
        };
    }

    private async Task RateGame(int rating)
    {
        _userRating = rating;
        await GameClient.AddRatingAsync(new GameRatingRequest { GameId = GameId, Rating = rating }, HttpConfig.Headers);
        await RefreshData();
    }

    private async Task DeleteGame()
    {
        var response = await GameClient.DeleteGameAsync(new DeleteGameRequest() { GameId = GameId }, HttpConfig.Headers);
        Snackbar.Add(response.Message, response.Success ? Severity.Success : Severity.Error);
        NavigationManager.NavigateTo("/Games");
    }

    private async Task DeleteComment(int commentId, int? parentId)
    {
        var response = await GameClient.DeleteGameCommentAsync(new DeleteGameCommentRequest { CommentId = commentId, ParentId = parentId }, HttpConfig.Headers);
        Snackbar.Add(response.Message, response.Success ? Severity.Success : Severity.Error);
        await RefreshData();
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

}